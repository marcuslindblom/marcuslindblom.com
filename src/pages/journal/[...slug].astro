---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostLayout from '../../layouts/PostLayout.astro';
import store from '../../store';

// Define an output param for getting the query stats
let stats;

const session = store.openSession();

const page = await session
  .query({ indexName: 'Content/ByUrl' })
  .whereEquals('url', Astro.url.pathname.replace(/\/$/, '')) // remove trailing slash
  .include('related')
  .statistics((s) => (stats = s))
  .firstOrNull();

const form = await session.load(page.related?.[0]?.id);

// const page = await session.advanced
//   .rawQuery(
//     `declare function getUrl(c) {
//       const displayName = c.displayName;
//       const visited = {};
//       const slugs = [];
//       do {
//         if (c.slug) {
//           slugs.unshift(c.slug);
//         }
//         if (visited[c.origin.id]) {
//           break;
//         }
//         visited[c.origin.id] = true;
//         c = load(c.origin.id);
//       } while (c);
//       return {
//         displayName: displayName,
//         url: slugs.shift() + slugs.join("/"),
//       }
//     }
//     from index 'Content/ByUrl' as post
//       where post.url == '${Astro.url.pathname.replace(/\/$/, '')}'
//       and post.published == true
//       order by post.publishedDate desc
//       load post.related[].id as related[]
//       select {
//           name: post.displayName,
//           heading: post.heading,
//           text: post.text,
//           publishedDate: post.publishedDate,
//           page_settings: post.page_settings,
//           page_images: post.page_images,
//           related: related.map(getUrl),
//           url: post.url
//         }`
//   )
//   .statistics((s) => (stats = s))
//   .singleOrNull();

if (!page) return Astro.redirect('/404');

// Log the query duration
console.log('Query duration: ' + stats.durationInMs);

try {
  // Get the query duration from the stats
  const queryDuration = stats.durationInMs;
  const lastQueryTime = stats.lastQueryTime;

  fetch('https://in.logs.betterstack.com', {
    headers: {
      'Content-Type': 'application/json',
      Authorization: 'Bearer A7KB9aGyb4mzyWohkx7dbJkP',
    },
    method: 'POST',
    body: JSON.stringify({
      dt: lastQueryTime,
      queryDuration: queryDuration,
      message:
        'Query duration for ' +
        Astro.url.pathname.replace(/\/$/, '') +
        ' is ' +
        queryDuration +
        ' ms',
    }),
  });
} catch (error) {
  console.log('Error logging query duration: ' + error);
}
---

<BaseLayout
  title={page.page_settings?.title}
  description={page.page_settings?.description}
  card={page.page_images?.og_image.source.url}
>
  <PostLayout
    heading={page.heading}
    text={page.text}
    publishedDate={page.publishedDate}
    related={page.related}
    form={form}
  />
</BaseLayout>
